<UserControl x:Class="Dmca.App.Views.ExecuteView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Dmca.App.ViewModels"
             d:DataContext="{d:DesignInstance Type=vm:ExecuteViewModel}"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Background="{StaticResource BackgroundBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel MaxWidth="900" HorizontalAlignment="Left" Margin="24">

            <TextBlock Text="Execute Cleanup" Style="{StaticResource SectionHeading}" />

            <!-- Step 1: Build Queue -->
            <Border Style="{StaticResource Card}">
                <StackPanel>
                    <TextBlock Text="Step 1: Build Action Queue" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />
                    <TextBlock Text="Build the ordered list of cleanup actions from the approved plan."
                               Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,12" TextWrapping="Wrap" />
                    <Button Content="Build Queue" Command="{Binding BuildQueueCommand}"
                            Style="{StaticResource PrimaryButton}" HorizontalAlignment="Left" />
                </StackPanel>
            </Border>

            <!-- Step 2: Dry Run -->
            <Border Style="{StaticResource Card}">
                <StackPanel>
                    <TextBlock Text="Step 2: Dry Run" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />
                    <TextBlock Text="Simulate execution without making changes. Review the actions that would be taken."
                               Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,12" TextWrapping="Wrap" />
                    <Button Content="â–¶ Run Dry Run" Command="{Binding DryRunCommand}"
                            Style="{StaticResource PrimaryButton}" HorizontalAlignment="Left" />
                </StackPanel>
            </Border>

            <!-- Action List -->
            <Border Style="{StaticResource Card}">
                <StackPanel>
                    <TextBlock Text="Actions" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />
                    <DataGrid ItemsSource="{Binding Actions}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              BorderThickness="1"
                              BorderBrush="#E0E0E0"
                              FontSize="13"
                              MaxHeight="300">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Order}" Width="40" />
                            <DataGridTextColumn Header="Type" Binding="{Binding ActionType}" Width="180" />
                            <DataGridTextColumn Header="Target" Binding="{Binding DisplayName}" Width="*" />
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100" />
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>

            <!-- Progress -->
            <Border Style="{StaticResource Card}"
                    Visibility="{Binding IsExecuting, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel>
                    <TextBlock Text="{Binding CurrentActionDescription}" FontSize="14" Margin="0,0,0,8" />
                    <ProgressBar Minimum="0" Maximum="{Binding ProgressTotal}"
                                 Value="{Binding ProgressCurrent}" Height="8" />
                    <Button Content="Cancel" Command="{Binding CancelExecutionCommand}"
                            Style="{StaticResource DangerButton}" HorizontalAlignment="Left" Margin="0,12,0,0" />
                </StackPanel>
            </Border>

            <!-- Step 3: Live Execution (Two-Step Confirmation) -->
            <Border Style="{StaticResource Card}" BorderBrush="{StaticResource DangerBrush}" BorderThickness="2">
                <StackPanel>
                    <TextBlock Text="Step 3: Live Execution" FontSize="16" FontWeight="SemiBold"
                               Foreground="{StaticResource DangerBrush}" Margin="0,0,0,8" />
                    <TextBlock Text="âš  This will make real changes to your system. Ensure you have reviewed the dry run results."
                               Foreground="{StaticResource DangerBrush}" FontSize="13" Margin="0,0,0,16" TextWrapping="Wrap" />

                    <CheckBox Content="I understand the risks and have reviewed the dry-run results"
                              IsChecked="{Binding AcknowledgeRisk}" Margin="0,0,0,12" FontSize="13" />

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <TextBlock Text="Type EXECUTE to confirm: " VerticalAlignment="Center" FontSize="13" />
                        <TextBox Text="{Binding ConfirmationText, UpdateSourceTrigger=PropertyChanged}"
                                 Width="150" Padding="6" FontSize="14" FontWeight="Bold"
                                 Foreground="{StaticResource DangerBrush}" />
                    </StackPanel>

                    <Button Content="ðŸ”¥ Execute Live" Command="{Binding ExecuteLiveCommand}"
                            IsEnabled="{Binding CanExecuteLive}"
                            Style="{StaticResource DangerButton}" HorizontalAlignment="Left" />
                </StackPanel>
            </Border>

            <!-- Status Message -->
            <TextBlock Text="{Binding StatusMessage}" FontSize="14" Margin="8,16,0,0"
                       Foreground="{StaticResource TextSecondaryBrush}" TextWrapping="Wrap" />

            <!-- Audit Log -->
            <Border Style="{StaticResource Card}" Margin="8,16,8,8">
                <StackPanel>
                    <TextBlock Text="Audit Log" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8" />
                    <DataGrid ItemsSource="{Binding AuditEntries}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              BorderThickness="1"
                              BorderBrush="#E0E0E0"
                              FontSize="12"
                              MaxHeight="250">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" Width="80" />
                            <DataGridTextColumn Header="Action" Binding="{Binding ActionType}" Width="160" />
                            <DataGridTextColumn Header="Target" Binding="{Binding TargetId}" Width="*" />
                            <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100" />
                            <DataGridTextColumn Header="Error" Binding="{Binding ErrorMessage}" Width="200" />
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
